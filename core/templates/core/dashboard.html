{% extends "core/base.html" %}
{% block titlepage %}Dashboard{% endblock %}

{% block principal %}

<div class="container-fluid mt-3">
  <div class="row">
    <div class="col-md-3">
      {% if user.perfil.rol == "ADMIN" %}
      <div class="card card-compact p-3 mb-3">
        <h6>Usuarios activos</h6>
        <h2>{{ total_usuarios }}</h2>
        <p class="small">√öltima actualizaci√≥n: hoy</p>
      </div>
      {% endif %}
      {% if user.perfil.rol == "JEFE_BODEGA" %}
      <div class="card card-compact p-3 mb-3">
        <h6>Insumos cr√≠ticos</h6>
        <h2>{{ insumos_criticos }}</h2>
      </div>
      {% endif %}
      {% if user.perfil.rol == "JEFE_FARMACIA" %}
      <div class="card card-compact p-3 mb-3">
        <h6>Farmacos criticos</h6>
        <h2>{{ farmacos_criticos }}</h2>
      </div>
      
      <div class="card card-compact p-3 mb-3">
        <h6>Dispensaciones hoy</h6>
        <h2>{{ dispensaciones_hoy }}</h2>
      </div>
   
      {% endif %}
      <div class="card card-compact p-3">
        <h6>Solicitudes pendientes</h6>
        <h2>{{ solicitudes_pendientes_farmacia }}</h2>
      </div>
    </div>

    <div class="card col-md-9">
      <div class="card-body">
        <h5 class="card-title mb-4">Resumen de actividad</h5>
        <div class="row">
            <!-- üî∂ Columna izquierda: Alertas de vencimientos -->
            <div class="col-md-6">
                <h6>Alertas de vencimientos pr√≥ximos</h6>

                <div class="list-group mb-3">
                    {% if user.perfil.rol == "JEFE_BODEGA" %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            ‚ö†Ô∏è Lotes que vencen en &lt; 30 d√≠as
                        </span>
                        <span class="badge bg-warning text-dark">
                            {{ vencimientos_30 }}
                        </span>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            ‚åõ Lotes que vencen entre 30 y 60 d√≠as
                        </span>
                        <span class="badge bg-secondary">
                            {{ vencimientos_30_60 }}
                        </span>
                    </div>
                    {% endif %}
                    {% if user.perfil.rol == "JEFE_FARMACIA" %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            ‚ö†Ô∏è Lotes que vencen en &lt; 30 d√≠as
                        </span>
                        <span class="badge bg-warning text-dark">
                            {{ vencimientos_farmacia_30 }}
                        </span>
                    </div>

                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <span>
                            ‚åõ Lotes que vencen entre 30 y 60 d√≠as
                        </span>
                        <span class="badge bg-secondary">
                            {{ vencimientos_farmacia_30_60 }}
                        </span>
                    </div> 
                    {% endif %}
                </div>
            </div>

            <!-- üî∑ Columna derecha: √öltimos movimientos -->
            <div class="col-md-6">
                <h6>√öltimos movimientos</h6>

                <div class="list-group">
                  {% if user.perfil.rol == "JEFE_BODEGA" %}
                    {% for mov in ult_mov_bodega|slice:":5" %}
                        <div class="list-group-item">
                            üè∑Ô∏è Bodega ‚Äì {{ mov.insumo.nombre }} ({{ mov.tipo }}) ‚Äì {{ mov.cantidad }}
                        </div>
                    {% endfor %}
                  {% endif %}
                  {% if user.perfil.rol == "JEFE_FARMACIA" %}
                    {% for mov in ult_mov_farmacia|slice:":5" %}
                        <div class="list-group-item">
                            üíä Farmacia ‚Äì {{ mov.medicamento.nombre }} ({{ mov.tipo }}) ‚Äì {{ mov.cantidad }}
                        </div>
                    {% endfor %}
                  {% endif %}
                </div>
            </div>
        </div>
      </div>

      <div class="card-body border-top mt-3 pt-3">
        <h6 class="mb-2">Accesos r√°pidos</h6>
        <div class="d-flex gap-2 mt-1">
          {% if user.perfil.rol == "ADMIN" %}
          <a class="btn btn-outline-primary" href="{% url 'manage_users' %}">Gestionar usuarios</a>
          {% endif %}
          <a class="btn btn-outline-primary" href="{% url 'inventario:inventory_list' %}">Ver inventario</a>
          <a class="btn btn-outline-primary" href="{% url 'reports' %}">Generar reportes</a>
        </div>
      </div>
    </div>
  </div>
</div>

{% if user.perfil.rol == "JEFE_BODEGA" %}

<div class="container-fluid mt-3">
  <h4>Panel Jefe de Bodega</h4>
  <div class="row mt-3">

    <div class="col-md-4">
      <div class="card p-3">
        <h6>Stock insumos bajos</h6>
        <p class="mb-0">
          {% if insumos_criticos_lista %}
              {% for m in insumos_criticos_lista %}
                  {{ m.nombre }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
          {% else %}
              <span class="text-success">No hay insumos cr√≠ticos</span>
          {% endif %}
        </p>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <h6>Vencimientos cr√≠ticos (&lt; 30 d√≠as)</h6>

        {% if lotes_vencen_30 %}
          <ul class="list-group list-group-flush">
            {% for lote in lotes_vencen_30 %}
            <li class="list-group-item d-flex justify-content-between">
              <span>{{ lote.insumo.nombre }} ‚Äî <strong>{{ lote.lote }}</strong></span>
              <span class="badge bg-danger">{{ lote.vencimiento }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-success mb-0">No hay lotes cr√≠ticos</p>
        {% endif %}
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <h6>Vencimientos pr√≥ximos (30‚Äì60 d√≠as)</h6>

        {% if lotes_vencen_30_60 %}
        <ul class="list-group list-group-flush">
          {% for lote in lotes_vencen_30_60 %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ lote.insumo.nombre }} ‚Äî <strong>{{ lote.lote }}</strong></span>
            <span class="badge bg-warning text-dark">{{ lote.vencimiento }}</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
          <p class="text-success mb-0">No hay lotes pr√≥ximos a vencer</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card mt-3 p-3">
    <h6>Reportes recientes</h6>
    <a class="btn btn-outline-primary" href="{% url 'reports' %}">Ver reportes</a>
  </div>
</div>

{% elif user.perfil.rol == "JEFE_FARMACIA" %}
<div class="container-fluid mt-3">
  <h4>Panel Jefe de Farmacia</h4>
  <div class="row">
    <div class="col-md-4">
      <div class="card p-3">
        <h6>Stock f√°rmacos bajos</h6>
        <p class="mb-0">
          {% if farmacos_criticos_lista %}
              {% for m in farmacos_criticos_lista %}
                  {{ m.nombre }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
          {% else %}
              <span class="text-success">No hay f√°rmacos cr√≠ticos</span>
          {% endif %}
        </p>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <h6>Vencimientos cr√≠ticos (&lt; 30 d√≠as)</h6>

        {% if lotes_farmacia_vencen_30 %}
          <ul class="list-group list-group-flush">
            {% for med in lotes_farmacia_vencen_30 %}
            <li class="list-group-item d-flex justify-content-between">
              <span>{{ med.nombre }} ‚Äî <strong>{{ med.lote }}</strong></span>
              <span class="badge bg-danger">{{ med.fecha_vencimiento }}</span>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-success mb-0">No hay f√°rmacos cr√≠ticos</p>
        {% endif %}
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3">
        <h6>Vencimientos pr√≥ximos (30‚Äì60 d√≠as)</h6>

        {% if lotes_farmacia_vencen_30_60 %}
        <ul class="list-group list-group-flush">
          {% for med in lotes_farmacia_vencen_30_60 %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ med.nombre }} ‚Äî <strong>{{ med.lote }}</strong></span>
            <span class="badge bg-warning text-dark">{{ med.fecha_vencimiento }}</span>
          </li>
          {% endfor %}
        </ul>
        {% else %}
          <p class="text-success mb-0">No hay f√°rmacos pr√≥ximos</p>
        {% endif %}
      </div>
    </div>


  </div>
  <div class="card mt-3 p-3">
    <h6>Reportes recientes</h6>
    <a class="btn btn-outline-primary" href="{% url 'reports' %}">Ver reportes</a>
  </div>
</div>
{% endif %}

</div>

{% endblock %}